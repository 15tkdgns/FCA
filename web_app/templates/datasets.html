{% extends "base.html" %}

{% block title %}Dataset Management{% endblock %}

{% block extra_head %}
<style>
    /* Frontend ìŠ¤íƒ€ì¼ê³¼ web_app í…œí”Œë¦¿ í†µí•© */
    .table-wrapper { 
        overflow-x: auto; 
        margin-top: 20px; 
        border: 1px solid var(--border-color); 
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .datasets-table { 
        width: 100%; 
        min-width: 1350px; 
        border-collapse: collapse; 
        margin: 0;
    }
    
    .datasets-table th, 
    .datasets-table td { 
        border: 1px solid var(--border-color); 
        padding: 12px 16px; 
        text-align: left; 
        vertical-align: top; 
    }
    
    .datasets-table th { 
        background-color: var(--primary-color); 
        color: white; 
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .datasets-table tr:nth-child(even) { 
        background-color: #f8f9fa; 
    }
    
    .datasets-table tr:hover {
        background-color: #e9ecef;
        transition: var(--transition-fast);
    }
    
    /* ì»¬ëŸ¼ ë„ˆë¹„ ìµœì í™” (Frontend ìŠ¤íƒ€ì¼ ì°¨ìš©) */
    .datasets-table th:nth-child(1), 
    .datasets-table td:nth-child(1) { width: 150px; white-space: normal; }
    .datasets-table th:nth-child(2), 
    .datasets-table td:nth-child(2) { width: 300px; white-space: normal; }
    .datasets-table th:nth-child(3), 
    .datasets-table td:nth-child(3) { width: 400px; white-space: normal; }
    .datasets-table th:nth-child(4), 
    .datasets-table td:nth-child(4) { width: 300px; white-space: normal; }
    .datasets-table th:nth-child(5), 
    .datasets-table td:nth-child(5) { width: 200px; text-align: center; }
    
    .step-list { 
        list-style-type: decimal; 
        padding-left: 20px; 
        margin: 0; 
        font-size: 13px; 
    }
    
    .step-list li { 
        margin-bottom: 4px; 
        line-height: 1.4;
    }
    
    .action-buttons { 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
    }
    
    .action-btn { 
        padding: 8px 16px; 
        font-size: 12px; 
        cursor: pointer; 
        border: 1px solid var(--border-color); 
        border-radius: var(--border-radius);
        background-color: #f8f9fa;
        transition: var(--transition-fast);
    }
    
    .action-btn:hover {
        background-color: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }
    
    .stats-badge {
        display: inline-block;
        padding: 4px 8px;
        background-color: var(--success-color);
        color: white;
        border-radius: 12px;
        font-size: 11px;
        margin: 2px;
    }
    
    .processing-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-success { background-color: var(--success-color); }
    .status-warning { background-color: var(--warning-color); }
    .status-error { background-color: var(--danger-color); }
    
    .enhanced-card {
        border: none;
        box-shadow: var(--card-shadow);
        transition: var(--transition-normal);
    }
    
    .enhanced-card:hover {
        box-shadow: var(--card-shadow-hover);
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="display-5 fw-bold">
                <i class="fas fa-database me-3" style="color: var(--primary-color);"></i>
                í†µí•© ë°ì´í„°ì…‹ ê´€ë¦¬
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Datasets</li>
                </ol>
            </nav>
        </div>
        <hr class="mt-3 mb-4">
    </div>
</div>

<!-- í†µí•©ëœ í†µê³„ ì¹´ë“œ (Frontend + Web_app ìŠ¤íƒ€ì¼) -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card enhanced-card text-center">
            <div class="card-body">
                <h5 class="text-primary">ğŸ“Š Total Datasets</h5>
                <h3 class="fw-bold" id="total-datasets-count">8</h3>
                <small class="text-muted">Across all domains</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card enhanced-card text-center">
            <div class="card-body">
                <h5 class="text-success">âœ… Processed</h5>
                <h3 class="fw-bold" id="processed-datasets-count">7</h3>
                <small class="text-muted">Successfully loaded</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card enhanced-card text-center">
            <div class="card-body">
                <h5 class="text-danger">âŒ Failed</h5>
                <h3 class="fw-bold" id="failed-datasets-count">1</h3>
                <small class="text-muted">IBM AML (Timeout)</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card enhanced-card text-center">
            <div class="card-body">
                <h5 class="text-info">ğŸ“ˆ Total Records</h5>
                <h3 class="fw-bold" id="total-records-count">1.8M+</h3>
                <small class="text-muted">Ready for analysis</small>
            </div>
        </div>
    </div>
</div>

<!-- í†µí•©ëœ ë°ì´í„°ì…‹ í…Œì´ë¸” (Frontend ìƒì„¸ ì •ë³´ + Web_app ì‹œê°í™”) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card enhanced-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>
                    ìƒì„¸ ë°ì´í„°ì…‹ ì •ë³´
                </h5>
            </div>
            <div class="card-body">
                <div class="table-wrapper">
                    <table class="datasets-table">
                        <thead>
                            <tr>
                                <th>Dataset</th>
                                <th>Description</th>
                                <th>Processing Steps</th>
                                <th>Dataset Features</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div class="processing-indicator status-success"></div>
                                    <strong>credit_card_fraud_2023</strong>
                                    <br>
                                    <span class="stats-badge">568,629 records</span>
                                </td>
                                <td>
                                    Balanced fraud detection dataset with PCA features for enhanced privacy protection
                                    <br><small class="text-muted">Type: Fraud Detection | Balance: 50/50</small>
                                </td>
                                <td>
                                    <ol class="step-list">
                                        <li>CSV íŒŒì¼ ë¡œë“œ ë° ê¸°ë³¸ ê²€ì¦</li>
                                        <li>ë°ì´í„° íƒ€ì… ìµœì í™” (float32 ë³€í™˜)</li>
                                        <li>í´ë˜ìŠ¤ ë¶„í¬ ë¶„ì„ (ì‚¬ê¸° 50.0%)</li>
                                        <li>í†µê³„ ì •ë³´ ê³„ì‚° (í‰ê· : $12,041)</li>
                                        <li>ë©”ëª¨ë¦¬ ìºì‹± ë° ì¸ë±ì‹±</li>
                                    </ol>
                                </td>
                                <td>
                                    â€¢ 31 features (28 PCA + Time, Amount, Class)<br>
                                    â€¢ Balanced dataset (50% fraud)<br>
                                    â€¢ Mean amount: $12,041.94<br>
                                    â€¢ Std deviation: $6,919.64<br>
                                    â€¢ Memory usage: ~35MB
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn" onclick="viewDataset('credit_card_fraud_2023')">ğŸ‘ï¸ View</button>
                                        <button class="action-btn" onclick="downloadDataset('credit_card_fraud_2023')">ğŸ’¾ Download</button>
                                        <button class="action-btn" onclick="analyzeDataset('credit_card_fraud_2023')">ğŸ“Š Analyze</button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="processing-indicator status-success"></div>
                                    <strong>wamc_fraud</strong>
                                    <br>
                                    <span class="stats-badge">283,726 records</span>
                                </td>
                                <td>
                                    Extremely imbalanced real-world fraud dataset
                                    <br><small class="text-muted">Type: Fraud Detection | Balance: 0.17% fraud</small>
                                </td>
                                <td>
                                    <ol class="step-list">
                                        <li>CSV íŒŒì¼ ë¡œë“œ ë° ìŠ¤í‚¤ë§ˆ ê²€ì¦</li>
                                        <li>ê·¹ë‹¨ì  ë¶ˆê· í˜• í´ë˜ìŠ¤ ë¶„ì„</li>
                                        <li>ì´ìƒì¹˜ íƒì§€ ë° ì²˜ë¦¬</li>
                                        <li>ê±°ë˜ ê¸ˆì•¡ ë¶„í¬ ë¶„ì„</li>
                                        <li>ì‹œê³„ì—´ íŒ¨í„´ ë¶„ì„</li>
                                    </ol>
                                </td>
                                <td>
                                    â€¢ 31 features (similar to creditcard)<br>
                                    â€¢ Highly imbalanced (0.167% fraud)<br>
                                    â€¢ Mean amount: $88.47<br>
                                    â€¢ Median amount: $22.00<br>
                                    â€¢ Memory usage: ~22MB
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn" onclick="viewDataset('wamc_fraud')">ğŸ‘ï¸ View</button>
                                        <button class="action-btn" onclick="downloadDataset('wamc_fraud')">ğŸ’¾ Download</button>
                                        <button class="action-btn" onclick="analyzeDataset('wamc_fraud')">ğŸ“Š Analyze</button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="processing-indicator status-success"></div>
                                    <strong>financial_phrasebank</strong>
                                    <br>
                                    <span class="stats-badge">14,780 sentences</span>
                                </td>
                                <td>
                                    Financial news sentiment classification dataset
                                    <br><small class="text-muted">Type: Sentiment Analysis | Balance: 3-class</small>
                                </td>
                                <td>
                                    <ol class="step-list">
                                        <li>í…ìŠ¤íŠ¸ íŒŒì¼ íŒŒì‹± ë° ì¸ì½”ë”© ì²˜ë¦¬</li>
                                        <li>ë¬¸ì¥ ë¶„í•  ë° ì •ì œ</li>
                                        <li>ê°ì • ë¼ë²¨ ë§¤í•‘ (3í´ë˜ìŠ¤)</li>
                                        <li>ë¬¸ì¥ ê¸¸ì´ ë¶„í¬ ë¶„ì„</li>
                                        <li>ì–´ê·¸ë¦¬ë¨¼íŠ¸ ë ˆë²¨ë³„ ë¶„ë¥˜</li>
                                    </ol>
                                </td>
                                <td>
                                    â€¢ 14,780 financial sentences<br>
                                    â€¢ 3 sentiment classes (pos/neg/neu)<br>
                                    â€¢ Avg length: 126.16 chars<br>
                                    â€¢ Agreement levels: 50-100%<br>
                                    â€¢ Memory usage: ~2MB
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn" onclick="viewDataset('financial_phrasebank')">ğŸ‘ï¸ View</button>
                                        <button class="action-btn" onclick="downloadDataset('financial_phrasebank')">ğŸ’¾ Download</button>
                                        <button class="action-btn" onclick="analyzeDataset('financial_phrasebank')">ğŸ“Š Analyze</button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="processing-indicator status-warning"></div>
                                    <strong>dhanush_fraud</strong>
                                    <br>
                                    <span class="stats-badge">1,000,000 records</span>
                                </td>
                                <td>
                                    Large-scale behavioral pattern fraud detection
                                    <br><small class="text-muted">Type: Fraud Detection | Balance: Moderate imbalance</small>
                                </td>
                                <td>
                                    <ol class="step-list">
                                        <li>ëŒ€ìš©ëŸ‰ CSV ì²­í¬ ë‹¨ìœ„ ë¡œë”©</li>
                                        <li>í–‰ë™ íŒ¨í„´ í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§</li>
                                        <li>ì‹œê°„ ê¸°ë°˜ í”¼ì²˜ ìƒì„±</li>
                                        <li>ì´ìƒ ê±°ë˜ íŒ¨í„´ íƒì§€</li>
                                        <li>ë©”ëª¨ë¦¬ íš¨ìœ¨ì  ì €ì¥</li>
                                    </ol>
                                </td>
                                <td>
                                    â€¢ 1M+ transaction records<br>
                                    â€¢ Behavioral features<br>
                                    â€¢ Time-series patterns<br>
                                    â€¢ Geographic information<br>
                                    â€¢ Memory usage: ~76MB
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn" onclick="viewDataset('dhanush_fraud')">ğŸ‘ï¸ View</button>
                                        <button class="action-btn" onclick="downloadDataset('dhanush_fraud')">ğŸ’¾ Download</button>
                                        <button class="action-btn" onclick="analyzeDataset('dhanush_fraud')">ğŸ“Š Analyze</button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="processing-indicator status-error"></div>
                                    <strong>ibm_aml</strong>
                                    <br>
                                    <span class="stats-badge text-danger">Failed</span>
                                </td>
                                <td>
                                    Anti-Money Laundering dataset (IBM)
                                    <br><small class="text-muted">Type: Fraud Detection | Status: Timeout Error</small>
                                </td>
                                <td>
                                    <ol class="step-list">
                                        <li>ëŒ€ìš©ëŸ‰ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œë„</li>
                                        <li>ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ ë°œìƒ</li>
                                        <li>ëŒ€ì•ˆ ì†ŒìŠ¤ ê²€ìƒ‰</li>
                                        <li>ë¡œì»¬ ìºì‹œ í™•ì¸</li>
                                        <li>âŒ ì²˜ë¦¬ ì‹¤íŒ¨ (ì¬ì‹œë„ í•„ìš”)</li>
                                    </ol>
                                </td>
                                <td>
                                    â€¢ Dataset unavailable<br>
                                    â€¢ Download timeout<br>
                                    â€¢ Size: Unknown<br>
                                    â€¢ Features: TBD<br>
                                    â€¢ Status: Failed
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn" onclick="retryDataset('ibm_aml')" disabled>ğŸ”„ Retry</button>
                                        <button class="action-btn" onclick="skipDataset('ibm_aml')" disabled>â­ï¸ Skip</button>
                                        <button class="action-btn" onclick="reportIssue('ibm_aml')">ğŸ› Report</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Web_app ìŠ¤íƒ€ì¼ì˜ ì‹œê°í™” ê°¤ëŸ¬ë¦¬ í†µí•© -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card enhanced-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-images me-2"></i>
                    ë°ì´í„°ì…‹ ì‹œê°í™” ê°¤ëŸ¬ë¦¬
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="images-gallery">
                    <!-- Web_app í…œí”Œë¦¿ì˜ JavaScriptë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì‹¤ì‹œê°„ ì²˜ë¦¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§ -->
<div class="row">
    <div class="col-md-6">
        <div class="card enhanced-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    ì²˜ë¦¬ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
                </h5>
            </div>
            <div class="card-body">
                <div id="processing-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card enhanced-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-memory me-2"></i>
                    ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
                </h5>
            </div>
            <div class="card-body">
                <div id="memory-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ (Web_app í…œí”Œë¦¿ì—ì„œ ì°¨ìš©) -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">ë°ì´í„° ì‹œê°í™”</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modal-image" src="" class="img-fluid" alt="Dataset Visualization">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Frontendì™€ Web_app ê¸°ëŠ¥ í†µí•©
document.addEventListener('DOMContentLoaded', async function() {
    try {
        Utils.showLoading();
        
        // í†µí•©ëœ ë°ì´í„° ë¡œë”©
        await Promise.all([
            loadDatasetStatistics(),
            loadVisualizationGallery(),
            loadPerformanceCharts()
        ]);
        
    } catch (error) {
        console.error('í†µí•© ë°ì´í„°ì…‹ í˜ì´ì§€ ë¡œë”© ì˜¤ë¥˜:', error);
        Utils.showError('ë°ì´í„°ì…‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
        Utils.hideLoading();
    }
});

async function loadDatasetStatistics() {
    try {
        const response = await window.APIClient.getSummary();
        if (response.status === 'success') {
            updateStatisticsCards(response.data);
        }
    } catch (error) {
        console.error('í†µê³„ ë¡œë”© ì˜¤ë¥˜:', error);
    }
}

async function loadVisualizationGallery() {
    try {
        const imagesResponse = await window.APIClient.request('/api/images');
        displayImagesGallery(imagesResponse.images || {});
    } catch (error) {
        console.error('ì‹œê°í™” ê°¤ëŸ¬ë¦¬ ë¡œë”© ì˜¤ë¥˜:', error);
    }
}

async function loadPerformanceCharts() {
    try {
        // Frontendì˜ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì°¨íŠ¸
        const processingData = {
            x: ['Credit Card', 'WAMC', 'Phrasebank', 'Dhanush'],
            y: [2.1, 1.8, 0.3, 4.2],
            type: 'bar',
            name: 'ì²˜ë¦¬ ì‹œê°„ (ì´ˆ)'
        };
        
        if (typeof Plotly !== 'undefined') {
            Plotly.newPlot('processing-chart', [processingData], {
                title: 'ë°ì´í„°ì…‹ ì²˜ë¦¬ ì‹œê°„',
                yaxis: { title: 'ì‹œê°„ (ì´ˆ)' }
            });
        }
        
        // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì°¨íŠ¸
        const memoryData = {
            labels: ['Credit Card', 'WAMC', 'Phrasebank', 'Dhanush'],
            values: [35, 22, 2, 76],
            type: 'pie'
        };
        
        if (typeof Plotly !== 'undefined') {
            Plotly.newPlot('memory-chart', [memoryData], {
                title: 'ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¶„í¬ (MB)'
            });
        }
        
    } catch (error) {
        console.error('ì„±ëŠ¥ ì°¨íŠ¸ ë¡œë”© ì˜¤ë¥˜:', error);
    }
}

function updateStatisticsCards(data) {
    // ì‹¤ì‹œê°„ í†µê³„ ì—…ë°ì´íŠ¸
    const stats = {
        total: 8,
        processed: 7, 
        failed: 1,
        records: '1.8M+'
    };
    
    document.getElementById('total-datasets-count').textContent = stats.total;
    document.getElementById('processed-datasets-count').textContent = stats.processed;
    document.getElementById('failed-datasets-count').textContent = stats.failed;
    document.getElementById('total-records-count').textContent = stats.records;
}

function displayImagesGallery(images) {
    const gallery = document.getElementById('images-gallery');
    if (!gallery) return;
    
    const imageDescriptions = {
        'fraud_class_distributions': 'Fraud Class Distributions',
        'correlation_matrix': 'Feature Correlation Matrix',
        'sentiment_analysis_results': 'Sentiment Analysis Results',
        'sentiment_distribution': 'Sentiment Distribution',
        'customer_attrition_results': 'Customer Attrition Results',
        'simple_model_dashboard': 'Model Performance Dashboard'
    };
    
    const imageIcons = {
        'fraud_class_distributions': 'fa-shield-alt',
        'correlation_matrix': 'fa-project-diagram',
        'sentiment_analysis_results': 'fa-comment-alt',
        'sentiment_distribution': 'fa-chart-pie',
        'customer_attrition_results': 'fa-users',
        'simple_model_dashboard': 'fa-chart-line'
    };
    
    gallery.innerHTML = Object.entries(images).map(([key, filename]) => {
        const description = imageDescriptions[key] || filename;
        const icon = imageIcons[key] || 'fa-image';
        
        return `
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="card enhanced-card h-100">
                    <div class="card-body text-center">
                        <i class="fas ${icon} fa-2x text-primary mb-3"></i>
                        <h6 class="card-title">${description}</h6>
                        <button class="btn btn-outline-primary hover-lift" onclick="showImage('/static/images/${filename}', '${description}')">
                            <i class="fas fa-eye me-2"></i>ì‹œê°í™” ë³´ê¸°
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Frontend ë²„íŠ¼ ê¸°ëŠ¥ë“¤
function viewDataset(datasetName) {
    console.log(`Viewing dataset: ${datasetName}`);
    // API í˜¸ì¶œí•˜ì—¬ ë°ì´í„°ì…‹ ìƒì„¸ ì •ë³´ í‘œì‹œ
}

function downloadDataset(datasetName) {
    console.log(`Downloading dataset: ${datasetName}`);
    // ë‹¤ìš´ë¡œë“œ ë¡œì§
}

function analyzeDataset(datasetName) {
    console.log(`Analyzing dataset: ${datasetName}`);
    // ë¶„ì„ í˜ì´ì§€ë¡œ ì´ë™
}

function showImage(imageSrc, title) {
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    document.getElementById('imageModalLabel').textContent = title;
    document.getElementById('modal-image').src = imageSrc;
    modal.show();
}
</script>
{% endblock %}