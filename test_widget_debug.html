<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCA Widget Debug Test</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>ğŸ› FCA ìœ„ì ¯ ë””ë²„ê¹… í…ŒìŠ¤íŠ¸</h1>
        <hr>
        
        <!-- API ì—°ê²° í…ŒìŠ¤íŠ¸ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>ğŸ“¡ API ì—°ê²° í…ŒìŠ¤íŠ¸</h5>
                    </div>
                    <div class="card-body">
                        <button id="test-summary" class="btn btn-primary me-2">Summary API í…ŒìŠ¤íŠ¸</button>
                        <button id="test-chart" class="btn btn-info me-2">Chart API í…ŒìŠ¤íŠ¸</button>
                        <button id="test-health" class="btn btn-success">Health API í…ŒìŠ¤íŠ¸</button>
                        <div id="api-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ì°¨íŠ¸ ë Œë”ë§ í…ŒìŠ¤íŠ¸ -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5>ğŸ“Š ì‹¤ì‹œê°„ ì°¨íŠ¸ í…ŒìŠ¤íŠ¸</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-chart-container" style="height: 400px; border: 1px dashed #ccc;"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5>ğŸ§ª ìˆ˜ë™ ì°¨íŠ¸ í…ŒìŠ¤íŠ¸</h5>
                    </div>
                    <div class="card-body">
                        <button id="manual-chart" class="btn btn-warning mb-3">ìˆ˜ë™ ì°¨íŠ¸ ìƒì„±</button>
                        <div id="manual-chart-container" style="height: 400px; border: 1px dashed #ccc;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ë””ë²„ê·¸ ì •ë³´ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>ğŸ” ë””ë²„ê·¸ ì •ë³´</h5>
                    </div>
                    <div class="card-body">
                        <div id="debug-info"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜
        function debugLog(message, data = null) {
            console.log('ğŸ› DEBUG:', message, data);
            const debugDiv = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<div><strong>[${timestamp}]</strong> ${message}</div>`;
            if (data) {
                debugDiv.innerHTML += `<pre class="bg-light p-2 mt-1 mb-2">${JSON.stringify(data, null, 2)}</pre>`;
            }
        }

        // API í´ë¼ì´ì–¸íŠ¸ (ë‹¨ìˆœí™”ëœ ë²„ì „)
        class SimpleAPIClient {
            constructor() {
                this.baseURL = window.location.protocol + '//' + window.location.hostname + ':5003';
                debugLog('API Client initialized', { baseURL: this.baseURL });
            }

            async request(endpoint) {
                try {
                    debugLog(`Requesting: ${endpoint}`);
                    const response = await fetch(this.baseURL + endpoint);
                    debugLog(`Response status: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    debugLog(`Response data received`, { endpoint, dataSize: JSON.stringify(data).length });
                    return data;
                } catch (error) {
                    debugLog(`Request failed: ${endpoint}`, error.message);
                    throw error;
                }
            }
        }

        const apiClient = new SimpleAPIClient();

        // Plotly ê°€ìš©ì„± í™•ì¸
        debugLog('Plotly availability check', { 
            available: typeof Plotly !== 'undefined',
            version: typeof Plotly !== 'undefined' ? Plotly.version : 'N/A'
        });

        // API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ë“¤
        document.getElementById('test-summary').addEventListener('click', async () => {
            try {
                const data = await apiClient.request('/api/summary');
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-success">
                        <h6>âœ… Summary API ì„±ê³µ</h6>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                debugLog('Summary API success', data);
            } catch (error) {
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-danger">
                        <h6>âŒ Summary API ì‹¤íŒ¨</h6>
                        <p>${error.message}</p>
                    </div>
                `;
                debugLog('Summary API failed', error);
            }
        });

        document.getElementById('test-chart').addEventListener('click', async () => {
            try {
                const data = await apiClient.request('/api/chart/overview');
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-success">
                        <h6>âœ… Chart API ì„±ê³µ</h6>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                debugLog('Chart API success', data);
                
                // ì°¨íŠ¸ ë Œë”ë§ ì‹œë„
                if (typeof Plotly !== 'undefined' && data.data) {
                    try {
                        const plotData = data.data;
                        Plotly.newPlot('test-chart-container', plotData.data, plotData.layout, {
                            responsive: true,
                            displayModeBar: true,
                            displaylogo: false
                        });
                        debugLog('Chart rendered successfully');
                    } catch (chartError) {
                        debugLog('Chart rendering failed', chartError);
                    }
                }
            } catch (error) {
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-danger">
                        <h6>âŒ Chart API ì‹¤íŒ¨</h6>
                        <p>${error.message}</p>
                    </div>
                `;
                debugLog('Chart API failed', error);
            }
        });

        document.getElementById('test-health').addEventListener('click', async () => {
            try {
                const data = await apiClient.request('/api/health');
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-success">
                        <h6>âœ… Health API ì„±ê³µ</h6>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                debugLog('Health API success', data);
            } catch (error) {
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-danger">
                        <h6>âŒ Health API ì‹¤íŒ¨</h6>
                        <p>${error.message}</p>
                    </div>
                `;
                debugLog('Health API failed', error);
            }
        });

        // ìˆ˜ë™ ì°¨íŠ¸ ìƒì„±
        document.getElementById('manual-chart').addEventListener('click', () => {
            debugLog('Creating manual chart');
            
            if (typeof Plotly === 'undefined') {
                debugLog('Plotly not available');
                document.getElementById('manual-chart-container').innerHTML = `
                    <div class="alert alert-danger">Plotly.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
                `;
                return;
            }

            const sampleData = [{
                x: ['Fraud Detection', 'Sentiment Analysis', 'Customer Attrition'],
                y: [0.94, 0.927, 0.857],
                type: 'bar',
                marker: {
                    color: ['#dc2626', '#2563eb', '#d97706']
                },
                text: ['94.0%', '92.7%', '85.7%'],
                textposition: 'auto'
            }];

            const layout = {
                title: 'ğŸ“Š Test Chart - Model Performance',
                yaxis: {
                    title: 'Performance Score',
                    tickformat: '.0%',
                    range: [0, 1]
                },
                font: { family: 'Inter, sans-serif', size: 12 },
                margin: { l: 50, r: 50, t: 80, b: 50 }
            };

            try {
                Plotly.newPlot('manual-chart-container', sampleData, layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false
                });
                debugLog('Manual chart created successfully');
            } catch (error) {
                debugLog('Manual chart creation failed', error);
                document.getElementById('manual-chart-container').innerHTML = `
                    <div class="alert alert-danger">ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}</div>
                `;
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ìë™ ì§„ë‹¨
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('Page loaded, starting automatic diagnosis');
            
            // 1. ê¸°ë³¸ í™˜ê²½ ì²´í¬
            debugLog('Environment check', {
                userAgent: navigator.userAgent,
                plotlyAvailable: typeof Plotly !== 'undefined',
                fetchAvailable: typeof fetch !== 'undefined',
                windowLocation: window.location.href
            });

            // 2. ìë™ìœ¼ë¡œ Summary API í…ŒìŠ¤íŠ¸
            setTimeout(() => {
                document.getElementById('test-summary').click();
            }, 1000);
            
            // 3. ìë™ìœ¼ë¡œ ìˆ˜ë™ ì°¨íŠ¸ í…ŒìŠ¤íŠ¸
            setTimeout(() => {
                document.getElementById('manual-chart').click();
            }, 2000);
        });
    </script>
</body>
</html>