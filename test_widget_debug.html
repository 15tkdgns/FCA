<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCA Widget Debug Test</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>🐛 FCA 위젯 디버깅 테스트</h1>
        <hr>
        
        <!-- API 연결 테스트 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>📡 API 연결 테스트</h5>
                    </div>
                    <div class="card-body">
                        <button id="test-summary" class="btn btn-primary me-2">Summary API 테스트</button>
                        <button id="test-chart" class="btn btn-info me-2">Chart API 테스트</button>
                        <button id="test-health" class="btn btn-success">Health API 테스트</button>
                        <div id="api-results" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 차트 렌더링 테스트 -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5>📊 실시간 차트 테스트</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-chart-container" style="height: 400px; border: 1px dashed #ccc;"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5>🧪 수동 차트 테스트</h5>
                    </div>
                    <div class="card-body">
                        <button id="manual-chart" class="btn btn-warning mb-3">수동 차트 생성</button>
                        <div id="manual-chart-container" style="height: 400px; border: 1px dashed #ccc;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 디버그 정보 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>🔍 디버그 정보</h5>
                    </div>
                    <div class="card-body">
                        <div id="debug-info"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 디버그 로그 함수
        function debugLog(message, data = null) {
            console.log('🐛 DEBUG:', message, data);
            const debugDiv = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<div><strong>[${timestamp}]</strong> ${message}</div>`;
            if (data) {
                debugDiv.innerHTML += `<pre class="bg-light p-2 mt-1 mb-2">${JSON.stringify(data, null, 2)}</pre>`;
            }
        }

        // API 클라이언트 (단순화된 버전)
        class SimpleAPIClient {
            constructor() {
                this.baseURL = window.location.protocol + '//' + window.location.hostname + ':5003';
                debugLog('API Client initialized', { baseURL: this.baseURL });
            }

            async request(endpoint) {
                try {
                    debugLog(`Requesting: ${endpoint}`);
                    const response = await fetch(this.baseURL + endpoint);
                    debugLog(`Response status: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    debugLog(`Response data received`, { endpoint, dataSize: JSON.stringify(data).length });
                    return data;
                } catch (error) {
                    debugLog(`Request failed: ${endpoint}`, error.message);
                    throw error;
                }
            }
        }

        const apiClient = new SimpleAPIClient();

        // Plotly 가용성 확인
        debugLog('Plotly availability check', { 
            available: typeof Plotly !== 'undefined',
            version: typeof Plotly !== 'undefined' ? Plotly.version : 'N/A'
        });

        // API 테스트 버튼들
        document.getElementById('test-summary').addEventListener('click', async () => {
            try {
                const data = await apiClient.request('/api/summary');
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-success">
                        <h6>✅ Summary API 성공</h6>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                debugLog('Summary API success', data);
            } catch (error) {
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-danger">
                        <h6>❌ Summary API 실패</h6>
                        <p>${error.message}</p>
                    </div>
                `;
                debugLog('Summary API failed', error);
            }
        });

        document.getElementById('test-chart').addEventListener('click', async () => {
            try {
                const data = await apiClient.request('/api/chart/overview');
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-success">
                        <h6>✅ Chart API 성공</h6>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                debugLog('Chart API success', data);
                
                // 차트 렌더링 시도
                if (typeof Plotly !== 'undefined' && data.data) {
                    try {
                        const plotData = data.data;
                        Plotly.newPlot('test-chart-container', plotData.data, plotData.layout, {
                            responsive: true,
                            displayModeBar: true,
                            displaylogo: false
                        });
                        debugLog('Chart rendered successfully');
                    } catch (chartError) {
                        debugLog('Chart rendering failed', chartError);
                    }
                }
            } catch (error) {
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-danger">
                        <h6>❌ Chart API 실패</h6>
                        <p>${error.message}</p>
                    </div>
                `;
                debugLog('Chart API failed', error);
            }
        });

        document.getElementById('test-health').addEventListener('click', async () => {
            try {
                const data = await apiClient.request('/api/health');
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-success">
                        <h6>✅ Health API 성공</h6>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                debugLog('Health API success', data);
            } catch (error) {
                document.getElementById('api-results').innerHTML = `
                    <div class="alert alert-danger">
                        <h6>❌ Health API 실패</h6>
                        <p>${error.message}</p>
                    </div>
                `;
                debugLog('Health API failed', error);
            }
        });

        // 수동 차트 생성
        document.getElementById('manual-chart').addEventListener('click', () => {
            debugLog('Creating manual chart');
            
            if (typeof Plotly === 'undefined') {
                debugLog('Plotly not available');
                document.getElementById('manual-chart-container').innerHTML = `
                    <div class="alert alert-danger">Plotly.js가 로드되지 않았습니다.</div>
                `;
                return;
            }

            const sampleData = [{
                x: ['Fraud Detection', 'Sentiment Analysis', 'Customer Attrition'],
                y: [0.94, 0.927, 0.857],
                type: 'bar',
                marker: {
                    color: ['#dc2626', '#2563eb', '#d97706']
                },
                text: ['94.0%', '92.7%', '85.7%'],
                textposition: 'auto'
            }];

            const layout = {
                title: '📊 Test Chart - Model Performance',
                yaxis: {
                    title: 'Performance Score',
                    tickformat: '.0%',
                    range: [0, 1]
                },
                font: { family: 'Inter, sans-serif', size: 12 },
                margin: { l: 50, r: 50, t: 80, b: 50 }
            };

            try {
                Plotly.newPlot('manual-chart-container', sampleData, layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false
                });
                debugLog('Manual chart created successfully');
            } catch (error) {
                debugLog('Manual chart creation failed', error);
                document.getElementById('manual-chart-container').innerHTML = `
                    <div class="alert alert-danger">차트 생성 실패: ${error.message}</div>
                `;
            }
        });

        // 페이지 로드 완료 후 자동 진단
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('Page loaded, starting automatic diagnosis');
            
            // 1. 기본 환경 체크
            debugLog('Environment check', {
                userAgent: navigator.userAgent,
                plotlyAvailable: typeof Plotly !== 'undefined',
                fetchAvailable: typeof fetch !== 'undefined',
                windowLocation: window.location.href
            });

            // 2. 자동으로 Summary API 테스트
            setTimeout(() => {
                document.getElementById('test-summary').click();
            }, 1000);
            
            // 3. 자동으로 수동 차트 테스트
            setTimeout(() => {
                document.getElementById('manual-chart').click();
            }, 2000);
        });
    </script>
</body>
</html>