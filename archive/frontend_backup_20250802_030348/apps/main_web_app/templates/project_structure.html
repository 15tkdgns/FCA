{% extends "base.html" %}

{% block title %}프로젝트 구조 - FCA Dashboard{% endblock %}

{% block extra_css %}
<style>
.structure-container {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.structure-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.structure-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
}

.structure-title i {
    margin-right: 10px;
    color: #3498db;
}

.tree-view {
    font-family: 'Monaco', 'Consolas', monospace;
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
    color: #e2e8f0;
    border-radius: 12px;
    padding: 25px;
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #4a5568;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

.tree-root {
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
}

.tree-item {
    line-height: 1.8;
    position: relative;
    transition: all 0.2s ease;
}

.tree-node {
    display: flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    margin: 1px 0;
    border-left: 2px solid transparent;
}

.tree-node:hover {
    background: rgba(74, 85, 104, 0.2);
    border-left: 2px solid #3182ce;
    transform: translateX(2px);
}

.tree-node.directory {
    font-weight: 500;
}

.tree-node.file {
    font-weight: 400;
    opacity: 0.9;
}

.expand-icon {
    display: inline-block;
    width: 16px;
    text-align: center;
    margin-right: 8px;
    font-size: 12px;
    color: #a0aec0;
    transition: transform 0.2s ease;
    cursor: pointer;
}

.tree-node.expanded .expand-icon {
    transform: rotate(0deg);
    color: #3182ce;
}

.tree-children {
    display: none;
    overflow: hidden;
    transition: all 0.3s ease-out;
}

.tree-children.expanded {
    display: block;
    animation: slideDown 0.3s ease-out;
}

.tree-children.collapsed {
    display: none;
}

.item-count {
    font-size: 11px;
    color: #a0aec0;
    margin-left: 8px;
    font-weight: normal;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}

.folder-icon {
    color: #ffd700;
    margin-right: 8px;
    font-size: 16px;
    filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.3));
}

.file-icon {
    margin-right: 8px;
    font-size: 14px;
    filter: drop-shadow(0 0 1px rgba(0,0,0,0.5));
}

.folder-name {
    color: #ffd700;
    font-weight: 600;
    text-shadow: 0 0 4px rgba(255, 215, 0, 0.2);
}

.file-name {
    color: #e2e8f0;
    font-weight: 400;
}

.python-file .file-name {
    color: #68d391;
}

.js-file .file-name {
    color: #f6e05e;
}

.css-file .file-name {
    color: #f687b3;
}

.html-file .file-name {
    color: #fc8181;
}

.json-file .file-name {
    color: #63b3ed;
}

.md-file .file-name {
    color: #9f7aea;
}

.csv-file .file-name {
    color: #4fd1c7;
}

.file-size {
    color: #a0aec0;
    font-size: 11px;
    margin-left: auto;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.tree-node:hover .file-size {
    opacity: 1;
}

.path-breadcrumb {
    background: rgba(74, 85, 104, 0.2);
    padding: 8px 12px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 12px;
    color: #a0aec0;
    border-left: 3px solid #3182ce;
}

.architecture-flow {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 1px solid #dee2e6;
}

.flow-level {
    display: flex;
    justify-content: center;
    margin: 10px 0;
}

.flow-box {
    background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    min-width: 160px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    cursor: pointer;
}

.flow-box:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
}

.flow-box.frontend {
    background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%);
}

.flow-box.api {
    background: linear-gradient(135deg, #4ecdc4 0%, #26a69a 100%);
}

.flow-box.engine {
    background: linear-gradient(135deg, #45b7d1 0%, #2196f3 100%);
}

.flow-box.data {
    background: linear-gradient(135deg, #96ceb4 0%, #66bb6a 100%);
}

.flow-box i {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
}

.flow-box div {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.flow-box small {
    font-size: 11px;
    opacity: 0.9;
    display: block;
}

.flow-arrow {
    font-size: 24px;
    color: #6c757d;
    margin: 10px 0;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-5px);
    }
    60% {
        transform: translateY(-3px);
    }
}

.file-stat-item {
    transition: all 0.2s ease;
    padding: 8px;
    border-radius: 6px;
}

.file-stat-item:hover {
    background: rgba(0,123,255,0.05);
    transform: translateX(3px);
}

.search-highlight {
    background: rgba(255, 235, 59, 0.2) !important;
    border-left: 3px solid #ffeb3b;
    animation: searchPulse 1s ease-in-out;
}

@keyframes searchPulse {
    0% { background: rgba(255, 235, 59, 0.4); }
    50% { background: rgba(255, 235, 59, 0.2); }
    100% { background: rgba(255, 235, 59, 0.2); }
}

.tree-controls {
    background: rgba(248, 249, 250, 0.8);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

/* Module Network Visualization */
.modules-network {
    position: relative;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #dee2e6;
}

.network-title {
    text-align: center;
    margin-bottom: 20px;
}

.modules-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
    position: relative;
    z-index: 2;
}

.module-node {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 2px solid transparent;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.module-node::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--module-color);
    opacity: 0.8;
}

.module-node:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    border-color: var(--module-color);
}

.module-node.highlighted {
    border-color: var(--module-color);
    box-shadow: 0 0 20px rgba(var(--module-color-rgb), 0.3);
    transform: scale(1.05);
}

.module-node.connected {
    opacity: 0.7;
    transform: translateY(-2px);
}

.module-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    border-radius: 12px;
    background: var(--module-color);
    color: white;
    font-size: 24px;
    margin-bottom: 15px;
}

.module-info {
    flex-grow: 1;
}

.module-name {
    font-size: 16px;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 8px;
}

.module-desc {
    font-size: 13px;
    color: #718096;
    margin-bottom: 10px;
    line-height: 1.4;
}

.module-path {
    font-size: 11px;
    color: #a0aec0;
    font-family: 'Monaco', monospace;
}

.module-stats {
    text-align: right;
    margin-top: 10px;
}

.connection-count {
    font-size: 11px;
    color: #4a5568;
    background: #edf2f7;
    padding: 4px 8px;
    border-radius: 12px;
}

.connection-svg {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 1;
}

/* API Explorer Styles */
.api-explorer {
    background: white;
    border-radius: 12px;
    overflow: hidden;
}

.api-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    margin: -1px -1px 20px -1px;
}

.stat-badge {
    text-align: center;
}

.stat-number {
    display: block;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 12px;
    opacity: 0.9;
}

.endpoint-category {
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 10px;
}

.category-header {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    background: #f8f9fa;
    cursor: pointer;
    transition: background 0.2s ease;
}

.category-header:hover {
    background: #e9ecef;
}

.category-name {
    flex-grow: 1;
    margin-left: 10px;
    font-weight: 600;
    color: #2d3748;
}

.category-count {
    background: #3182ce;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    margin-right: 10px;
}

.expand-category {
    transition: transform 0.2s ease;
}

.category-endpoints {
    padding: 0 20px 20px 20px;
    display: none;
}

.category-endpoints.expanded {
    display: block;
    animation: slideDown 0.3s ease-out;
}

.endpoint-item {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}

.endpoint-item:hover {
    border-color: #3182ce;
    box-shadow: 0 2px 8px rgba(49, 130, 206, 0.1);
}

.endpoint-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.method-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    margin-right: 12px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.method-get { background: #10b981; color: white; }
.method-post { background: #3b82f6; color: white; }
.method-put { background: #f59e0b; color: white; }
.method-delete { background: #ef4444; color: white; }
.method-default { background: #6b7280; color: white; }

.endpoint-path {
    font-family: 'Monaco', monospace;
    font-size: 13px;
    background: #f1f5f9;
    padding: 4px 8px;
    border-radius: 4px;
    color: #1e293b;
}

.endpoint-desc {
    font-size: 13px;
    color: #64748b;
    margin-bottom: 10px;
}

.endpoint-actions {
    text-align: right;
}

.test-endpoint {
    font-size: 11px;
    padding: 6px 12px;
}

.architecture-diagram {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
}

.module-box {
    display: inline-block;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    margin: 10px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    min-width: 150px;
    transition: transform 0.3s ease;
}

.module-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.module-box h5 {
    margin: 0 0 5px 0;
    font-weight: 600;
}

.module-box small {
    opacity: 0.9;
}

.flow-arrow {
    font-size: 24px;
    color: #3498db;
    margin: 10px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.tech-stack {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.tech-badge {
    background: #4a5568;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.tech-badge.frontend {
    background: #ff6b6b;
}

.tech-badge.backend {
    background: #4ecdc4;
}

.tech-badge.ml {
    background: #45b7d1;
}

.tech-badge.data {
    background: #96ceb4;
}

.component-diagram {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
    padding: 20px;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.toggle-section {
    margin-bottom: 20px;
}

.toggle-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-right: 10px;
    transition: background 0.3s ease;
}

.toggle-btn:hover {
    background: #2980b9;
}

.toggle-btn.active {
    background: #27ae60;
}

.collapsible-content {
    display: none;
}

.collapsible-content.active {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-sitemap"></i>
                        프로젝트 구조 시각화
                    </h1>
                    <p class="text-muted mt-2">FCA (Financial Crime Analysis) 프로젝트의 논리적 구조와 폴더 구조</p>
                </div>
                <div>
                    <button id="refresh-structure" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> 새로고침
                    </button>
                </div>
            </div>

            <!-- Statistics Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-files">-</div>
                    <div class="stat-label">총 파일 수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="python-files">-</div>
                    <div class="stat-label">Python 파일</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="js-files">-</div>
                    <div class="stat-label">JavaScript 파일</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-directories">-</div>
                    <div class="stat-label">디렉토리 수</div>
                </div>
            </div>

            <!-- Project Architecture Overview -->
            <div class="structure-section">
                <h4 class="structure-title">
                    <i class="fas fa-building"></i>
                    프로젝트 아키텍처 개요
                </h4>
                <div class="architecture-diagram">
                    <div class="component-diagram">
                        <div class="module-box">
                            <h5><i class="fas fa-desktop"></i> Frontend</h5>
                            <small>웹 인터페이스 & 대시보드</small>
                        </div>
                        <div class="flow-arrow">→</div>
                        <div class="module-box">
                            <h5><i class="fas fa-server"></i> Flask API</h5>
                            <small>REST API & 라우팅</small>
                        </div>
                        <div class="flow-arrow">→</div>
                        <div class="module-box">
                            <h5><i class="fas fa-brain"></i> FCA Engines</h5>
                            <small>ML 모델 & 분석</small>
                        </div>
                        <div class="flow-arrow">→</div>
                        <div class="module-box">
                            <h5><i class="fas fa-database"></i> Data Layer</h5>
                            <small>데이터셋 & 저장소</small>
                        </div>
                    </div>
                </div>

                <!-- Technology Stack -->
                <div class="mt-4">
                    <h6><i class="fas fa-code"></i> 기술 스택</h6>
                    <div class="tech-stack">
                        <span class="tech-badge frontend">HTML5/CSS3</span>
                        <span class="tech-badge frontend">JavaScript ES6+</span>
                        <span class="tech-badge frontend">Bootstrap 5</span>
                        <span class="tech-badge frontend">Plotly.js</span>
                        <span class="tech-badge backend">Python 3.12</span>
                        <span class="tech-badge backend">Flask</span>
                        <span class="tech-badge ml">Scikit-learn</span>
                        <span class="tech-badge ml">NLTK</span>
                        <span class="tech-badge ml">XGBoost</span>
                        <span class="tech-badge data">Pandas</span>
                        <span class="tech-badge data">NumPy</span>
                    </div>
                </div>
            </div>

            <!-- Toggle Sections -->
            <div class="toggle-section">
                <button class="toggle-btn active" data-target="folder-structure">폴더 구조</button>
                <button class="toggle-btn" data-target="logical-structure">논리적 구조</button>
                <button class="toggle-btn" data-target="file-analysis">파일 분석</button>
            </div>

            <!-- Folder Structure -->
            <div id="folder-structure" class="structure-section collapsible-content active">
                <h4 class="structure-title">
                    <i class="fas fa-folder-tree"></i>
                    폴더 구조
                </h4>
                
                <!-- Search and Filter Controls -->
                <div class="tree-controls mb-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="tree-search" placeholder="파일이나 폴더 검색...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="expand-all">
                                    <i class="fas fa-expand-arrows-alt"></i> 모두 펼치기
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="collapse-all">
                                    <i class="fas fa-compress-arrows-alt"></i> 모두 접기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tree-view" id="folder-tree">
                    <div class="loading-spinner"></div> 로딩 중...
                </div>
            </div>

            <!-- Logical Structure -->
            <div id="logical-structure" class="structure-section collapsible-content">
                <h4 class="structure-title">
                    <i class="fas fa-project-diagram"></i>
                    논리적 구조
                </h4>
                
                <!-- Architecture Flow Diagram -->
                <div class="mb-4">
                    <h5><i class="fas fa-sitemap"></i> 아키텍처 플로우</h5>
                    <div class="architecture-flow">
                        <div class="flow-level">
                            <div class="flow-box frontend">
                                <i class="fas fa-desktop"></i>
                                <div>Frontend</div>
                                <small>HTML/CSS/JS</small>
                            </div>
                        </div>
                        <div class="flow-arrow">⬇️</div>
                        <div class="flow-level">
                            <div class="flow-box api">
                                <i class="fas fa-server"></i>
                                <div>Flask API</div>
                                <small>REST 엔드포인트</small>
                            </div>
                        </div>
                        <div class="flow-arrow">⬇️</div>
                        <div class="flow-level">
                            <div class="flow-box engine">
                                <i class="fas fa-brain"></i>
                                <div>FCA Engines</div>
                                <small>ML 분석 엔진</small>
                            </div>
                        </div>
                        <div class="flow-arrow">⬇️</div>
                        <div class="flow-level">
                            <div class="flow-box data">
                                <i class="fas fa-database"></i>
                                <div>Data Layer</div>
                                <small>데이터셋 & 저장소</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-cogs"></i> 핵심 모듈</h6>
                            </div>
                            <div class="card-body">
                                <div id="core-modules">
                                    <div class="loading-spinner"></div> 로딩 중...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-plug"></i> API 엔드포인트</h6>
                            </div>
                            <div class="card-body">
                                <div id="api-endpoints">
                                    <div class="loading-spinner"></div> 로딩 중...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Analysis -->
            <div id="file-analysis" class="structure-section collapsible-content">
                <h4 class="structure-title">
                    <i class="fas fa-chart-pie"></i>
                    파일 분석
                </h4>
                <div class="row">
                    <div class="col-md-8">
                        <div id="file-distribution-chart"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="file-stats">
                            <div class="loading-spinner"></div> 로딩 중...
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
class ProjectStructureManager {
    constructor() {
        this.currentView = 'folder-structure';
        this.structureData = null;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.loadStructureData();
    }

    setupEventListeners() {
        // Toggle buttons
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.switchView(e.target.dataset.target);
            });
        });

        // Refresh button
        document.getElementById('refresh-structure').addEventListener('click', () => {
            this.loadStructureData(true);
        });

        // Search functionality
        const searchInput = document.getElementById('tree-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.searchTree(e.target.value);
            });
        }

        // Expand/Collapse all buttons
        const expandAllBtn = document.getElementById('expand-all');
        const collapseAllBtn = document.getElementById('collapse-all');
        
        if (expandAllBtn) {
            expandAllBtn.addEventListener('click', () => {
                this.expandAllNodes();
            });
        }
        
        if (collapseAllBtn) {
            collapseAllBtn.addEventListener('click', () => {
                this.collapseAllNodes();
            });
        }
    }

    switchView(targetView) {
        // Update button states
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-target="${targetView}"]`).classList.add('active');

        // Show/hide content sections
        document.querySelectorAll('.collapsible-content').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(targetView).classList.add('active');

        this.currentView = targetView;

        // Load specific content if needed
        if (targetView === 'file-analysis' && !document.getElementById('file-distribution-chart').hasChildNodes()) {
            this.renderFileAnalysis();
        }
    }

    async loadStructureData(forceRefresh = false) {
        try {
            const response = await fetch('/api/project/structure' + (forceRefresh ? '?refresh=true' : ''));
            const result = await response.json();
            
            if (result.status === 'success') {
                this.structureData = result.data;
            } else {
                throw new Error(result.message || 'API 응답 오류');
            }
            
            this.updateStats();
            this.renderFolderStructure();
            this.renderLogicalStructure();
            
            if (this.currentView === 'file-analysis') {
                this.renderFileAnalysis();
            }
        } catch (error) {
            console.error('Failed to load structure data:', error);
            this.showError('구조 데이터를 로드하는데 실패했습니다: ' + error.message);
        }
    }

    updateStats() {
        if (!this.structureData) return;

        const stats = this.structureData.statistics;
        document.getElementById('total-files').textContent = stats.total_files || 0;
        document.getElementById('python-files').textContent = stats.python_files || 0;
        document.getElementById('js-files').textContent = stats.js_files || 0;
        document.getElementById('total-directories').textContent = stats.total_directories || 0;
    }

    renderFolderStructure() {
        if (!this.structureData) return;

        const treeContainer = document.getElementById('folder-tree');
        const folderData = this.structureData.folder_structure;
        
        // Add breadcrumb
        const breadcrumb = `<div class="path-breadcrumb">
            <i class="fas fa-folder-open"></i> 프로젝트 루트: /root/FCA (${folderData.children ? folderData.children.length : 0}개 항목)
        </div>`;
        
        // Start rendering from root
        let html = '<div class="tree-root">';
        html += this.renderTreeNode(folderData, 0);
        html += '</div>';
        
        treeContainer.innerHTML = breadcrumb + html;
        
        // Add click handlers for expandable nodes
        this.addTreeEventListeners();
        
        // Auto-expand first level for better UX
        this.expandFirstLevel();
    }

    renderTreeNode(node, depth = 0) {
        if (!node) return '';
        
        const nodeId = this.generateNodeId(node.path || node.name || '');
        const indentLevel = depth;
        let html = '';
        
        if (node.type === 'directory') {
            const hasChildren = node.children && node.children.length > 0;
            const childCount = hasChildren ? node.children.length : 0;
            const expandableClass = hasChildren ? 'expandable' : '';
            
            // Create directory node
            html += `
                <div class="tree-item" style="margin-left: ${indentLevel * 20}px;">
                    <div class="tree-node directory ${expandableClass}" 
                         data-node-id="${nodeId}" 
                         data-path="${node.path || ''}"
                         data-depth="${depth}">
                        <span class="expand-icon">${hasChildren ? '▶' : ''}</span>
                        <span class="folder-icon">📁</span>
                        <span class="folder-name">${node.name}</span>
                        <span class="item-count">${childCount > 0 ? `(${childCount})` : ''}</span>
                    </div>
                    ${hasChildren ? `<div class="tree-children collapsed" id="children-${nodeId}">` : ''}`;
            
            // Render children if they exist
            if (hasChildren) {
                // Sort children: directories first, then files
                const sortedChildren = [...node.children].sort((a, b) => {
                    if (a.type === 'directory' && b.type === 'file') return -1;
                    if (a.type === 'file' && b.type === 'directory') return 1;
                    return a.name.localeCompare(b.name);
                });
                
                sortedChildren.forEach(child => {
                    html += this.renderTreeNode(child, depth + 1);
                });
                
                html += `</div>`;
            }
            
            html += `</div>`;
            
        } else if (node.type === 'file') {
            const icon = this.getFileIcon(node.name);
            const className = this.getFileClass(node.name);
            const fileSize = node.size ? this.formatFileSize(node.size) : '';
            
            html += `
                <div class="tree-item" style="margin-left: ${indentLevel * 20}px;">
                    <div class="tree-node file ${className}" 
                         data-path="${node.path || ''}"
                         data-size="${node.size || 0}">
                        <span class="expand-icon"></span>
                        <span class="file-icon">${icon}</span>
                        <span class="file-name">${node.name}</span>
                        <span class="file-size">${fileSize}</span>
                    </div>
                </div>`;
        }
        
        return html;
    }

    generateNodeId(path) {
        return path.replace(/[^a-zA-Z0-9]/g, '_');
    }

    formatFileSize(bytes) {
        if (!bytes) return '';
        const sizes = ['B', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    addTreeEventListeners() {
        const expandableNodes = document.querySelectorAll('.tree-node.expandable');
        expandableNodes.forEach(node => {
            node.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggleNode(node);
            });
        });
    }

    toggleNode(node) {
        const nodeId = node.dataset.nodeId;
        const children = document.getElementById(`children-${nodeId}`);
        const expandIcon = node.querySelector('.expand-icon');
        
        if (children && expandIcon) {
            const isCollapsed = children.classList.contains('collapsed');
            
            if (isCollapsed) {
                // Expand
                children.classList.remove('collapsed');
                children.classList.add('expanded');
                node.classList.add('expanded');
                expandIcon.textContent = '▼';
                expandIcon.style.transform = 'rotate(0deg)';
            } else {
                // Collapse
                children.classList.remove('expanded');
                children.classList.add('collapsed');
                node.classList.remove('expanded');
                expandIcon.textContent = '▶';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }
    }

    expandFirstLevel() {
        // Auto-expand the first level directories for better UX
        const firstLevelNodes = document.querySelectorAll('[data-depth="0"].expandable');
        firstLevelNodes.forEach(node => {
            // Only expand if it's a major directory
            const folderName = node.querySelector('.folder-name').textContent.toLowerCase();
            if (['apps', 'fca', 'core', 'data', 'config'].includes(folderName)) {
                this.toggleNode(node);
            }
        });
    }

    getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            'py': '🐍',
            'js': '⚡',
            'html': '🌐',
            'css': '🎨',
            'json': '⚙️',
            'md': '📝',
            'txt': '📄',
            'csv': '📊',
            'pkl': '💾',
            'png': '🖼️',
            'jpg': '🖼️',
            'jpeg': '🖼️',
            'gif': '🖼️',
            'svg': '🎨',
            'pdf': '📕',
            'log': '📋',
            'toml': '⚙️',
            'yml': '⚙️',
            'yaml': '⚙️',
            'xml': '🗂️',
            'sql': '🗄️',
            'db': '🗄️',
            'zip': '📦',
            'tar': '📦',
            'gz': '📦'
        };
        return icons[ext] || '📄';
    }

    getFileClass(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const classes = {
            'py': 'python-file',
            'js': 'js-file',
            'html': 'html-file',
            'css': 'css-file'
        };
        return classes[ext] || 'file';
    }

    renderLogicalStructure() {
        if (!this.structureData) return;

        const modules = this.structureData.logical_structure.core_modules;
        const endpoints = this.structureData.logical_structure.api_endpoints;

        // Render interactive core modules with connections
        this.renderInteractiveModules(modules);
        
        // Render enhanced API endpoints
        this.renderEnhancedEndpoints(endpoints);
        
        // Add module interaction listeners
        this.addModuleInteractions();
    }

    renderInteractiveModules(modules) {
        const coreModulesContainer = document.getElementById('core-modules');
        
        let modulesHtml = `
            <div class="modules-network">
                <div class="network-title">
                    <h6><i class="fas fa-project-diagram"></i> 모듈 의존성 네트워크</h6>
                </div>
                <div class="modules-container">
        `;
        
        // Define module types and their relationships
        const moduleTypes = {
            'FCA Engines': { icon: 'fas fa-brain', color: '#4fc3f7', connections: ['Data Processing', 'API Layer'] },
            'Web Application': { icon: 'fas fa-globe', color: '#66bb6a', connections: ['API Layer', 'Visualization'] },
            'Data Processing': { icon: 'fas fa-database', color: '#ffa726', connections: ['FCA Engines'] },
            'Visualization': { icon: 'fas fa-chart-line', color: '#ef5350', connections: ['Web Application'] },
            'API Layer': { icon: 'fas fa-server', color: '#ab47bc', connections: ['Web Application', 'FCA Engines'] }
        };
        
        modules.forEach((module, index) => {
            const moduleType = moduleTypes[module.name] || { icon: 'fas fa-cube', color: '#9e9e9e', connections: [] };
            
            modulesHtml += `
                <div class="module-node" 
                     data-module="${module.name}" 
                     data-connections='${JSON.stringify(moduleType.connections)}'
                     style="--module-color: ${moduleType.color}">
                    <div class="module-icon">
                        <i class="${moduleType.icon}"></i>
                    </div>
                    <div class="module-info">
                        <h6 class="module-name">${module.name}</h6>
                        <p class="module-desc">${module.description}</p>
                        <small class="module-path">📁 ${module.path}</small>
                    </div>
                    <div class="module-stats">
                        <span class="connection-count">${moduleType.connections.length} 연결</span>
                    </div>
                </div>
            `;
        });
        
        modulesHtml += `
                </div>
                <svg class="connection-svg" width="100%" height="400">
                    <!-- Connections will be drawn here -->
                </svg>
            </div>
        `;
        
        coreModulesContainer.innerHTML = modulesHtml;
        
        // Draw connections after DOM is updated
        setTimeout(() => this.drawModuleConnections(), 100);
    }

    renderEnhancedEndpoints(endpoints) {
        const apiContainer = document.getElementById('api-endpoints');
        
        // Group endpoints by category
        const groupedEndpoints = this.groupEndpointsByCategory(endpoints);
        
        let apiHtml = `
            <div class="api-explorer">
                <div class="api-stats mb-3">
                    <div class="row text-center">
                        <div class="col">
                            <div class="stat-badge">
                                <i class="fas fa-plug"></i>
                                <span class="stat-number">${endpoints.length}</span>
                                <span class="stat-label">엔드포인트</span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="stat-badge">
                                <i class="fas fa-layer-group"></i>
                                <span class="stat-number">${Object.keys(groupedEndpoints).length}</span>
                                <span class="stat-label">카테고리</span>
                            </div>
                        </div>
                    </div>
                </div>
        `;
        
        Object.entries(groupedEndpoints).forEach(([category, categoryEndpoints]) => {
            apiHtml += `
                <div class="endpoint-category">
                    <div class="category-header" data-category="${category}">
                        <i class="fas fa-folder-open"></i>
                        <span class="category-name">${category}</span>
                        <span class="category-count">${categoryEndpoints.length}</span>
                        <i class="fas fa-chevron-down expand-category"></i>
                    </div>
                    <div class="category-endpoints expanded">
            `;
            
            categoryEndpoints.forEach(endpoint => {
                const methodColor = this.getMethodColor(endpoint.method);
                const methodIcon = this.getMethodIcon(endpoint.method);
                
                apiHtml += `
                    <div class="endpoint-item" data-method="${endpoint.method}">
                        <div class="endpoint-header">
                            <span class="method-badge ${methodColor}">
                                <i class="${methodIcon}"></i>
                                ${endpoint.method}
                            </span>
                            <code class="endpoint-path">${endpoint.path}</code>
                        </div>
                        <p class="endpoint-desc">${endpoint.description}</p>
                        <div class="endpoint-actions">
                            <button class="btn btn-sm btn-outline-primary test-endpoint" 
                                    data-url="${endpoint.path}" 
                                    data-method="${endpoint.method}">
                                <i class="fas fa-play"></i> 테스트
                            </button>
                        </div>
                    </div>
                `;
            });
            
            apiHtml += `
                    </div>
                </div>
            `;
        });
        
        apiHtml += `</div>`;
        apiContainer.innerHTML = apiHtml;
    }

    groupEndpointsByCategory(endpoints) {
        const groups = {
            '시스템': [],
            '데이터': [],
            '분석': [],
            '모델': [],
            '기타': []
        };
        
        endpoints.forEach(endpoint => {
            if (endpoint.path.includes('/summary') || endpoint.path.includes('/health') || endpoint.path.includes('/metrics')) {
                groups['시스템'].push(endpoint);
            } else if (endpoint.path.includes('/dataset') || endpoint.path.includes('/data')) {
                groups['데이터'].push(endpoint);
            } else if (endpoint.path.includes('/fraud') || endpoint.path.includes('/sentiment') || endpoint.path.includes('/attrition')) {
                groups['분석'].push(endpoint);
            } else if (endpoint.path.includes('/model') || endpoint.path.includes('/compare')) {
                groups['모델'].push(endpoint);
            } else {
                groups['기타'].push(endpoint);
            }
        });
        
        // Remove empty groups
        Object.keys(groups).forEach(key => {
            if (groups[key].length === 0) delete groups[key];
        });
        
        return groups;
    }

    getMethodColor(method) {
        const colors = {
            'GET': 'method-get',
            'POST': 'method-post',
            'PUT': 'method-put',
            'DELETE': 'method-delete'
        };
        return colors[method] || 'method-default';
    }

    getMethodIcon(method) {
        const icons = {
            'GET': 'fas fa-download',
            'POST': 'fas fa-upload',
            'PUT': 'fas fa-edit',
            'DELETE': 'fas fa-trash'
        };
        return icons[method] || 'fas fa-plug';
    }

    renderFileAnalysis() {
        if (!this.structureData) return;

        const fileStats = this.structureData.file_analysis;
        
        // Enhanced color palette for better visualization
        const colors = [
            '#4FC3F7', '#66BB6A', '#FFA726', '#EF5350', '#AB47BC', 
            '#26C6DA', '#FFCA28', '#8BC34A', '#FF7043', '#9C27B0',
            '#42A5F5', '#66BB6A', '#FFA726', '#EF5350', '#AB47BC'
        ];
        
        // Create interactive donut chart
        const chartData = [{
            values: Object.values(fileStats.by_extension),
            labels: Object.keys(fileStats.by_extension).map(ext => {
                const icon = this.getFileIcon('file.' + ext);
                return `${icon} .${ext}`;
            }),
            type: 'pie',
            hole: 0.5,
            marker: {
                colors: colors,
                line: {
                    color: '#FFFFFF',
                    width: 2
                }
            },
            textinfo: 'label+percent',
            textposition: 'outside',
            hovertemplate: '<b>%{label}</b><br>' +
                          'Files: %{value}<br>' +
                          'Percentage: %{percent}<br>' +
                          '<extra></extra>',
            sort: false
        }];

        const layout = {
            title: {
                text: '📊 파일 확장자별 분포',
                font: { size: 18, color: '#2c3e50' }
            },
            showlegend: true,
            legend: {
                orientation: 'h',
                x: 0.5,
                xanchor: 'center',
                y: -0.2
            },
            height: 450,
            font: { 
                family: 'Inter, Arial, sans-serif',
                size: 12
            },
            margin: { t: 60, b: 100, l: 50, r: 50 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            annotations: [{
                text: `총 ${fileStats.total_files}개<br>파일`,
                x: 0.5, y: 0.5,
                font: { size: 16, color: '#2c3e50' },
                showarrow: false
            }]
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d'],
            displaylogo: false
        };

        Plotly.newPlot('file-distribution-chart', chartData, layout, config);

        // Enhanced file statistics with icons and better styling
        const statsContainer = document.getElementById('file-stats');
        let statsHtml = `
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-bar"></i> 상세 통계</h6>
                </div>
                <div class="card-body p-3">
        `;
        
        // Sort by file count for better display
        const sortedStats = Object.entries(fileStats.by_extension)
            .sort(([,a], [,b]) => b - a);
        
        sortedStats.forEach(([ext, count], index) => {
            const percentage = ((count / fileStats.total_files) * 100).toFixed(1);
            const icon = this.getFileIcon('file.' + ext);
            const color = colors[index % colors.length];
            
            statsHtml += `
                <div class="file-stat-item mb-3">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                        <div class="d-flex align-items-center">
                            <span class="file-type-icon me-2" style="font-size: 16px;">${icon}</span>
                            <span class="fw-semibold">.${ext}</span>
                        </div>
                        <div class="text-end">
                            <span class="badge rounded-pill" style="background-color: ${color}; color: white;">
                                ${count}개
                            </span>
                            <small class="text-muted ms-1">${percentage}%</small>
                        </div>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar" style="width: ${percentage}%; background-color: ${color};"></div>
                    </div>
                </div>
            `;
        });
        
        statsHtml += `
                </div>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i> 
                    가장 많은 파일: ${sortedStats[0] ? '.' + sortedStats[0][0] + ' (' + sortedStats[0][1] + '개)' : 'N/A'}
                </small>
            </div>
        `;
        
        statsContainer.innerHTML = statsHtml;
    }

    // Module connection and interaction functions
    drawModuleConnections() {
        const svg = document.querySelector('.connection-svg');
        const modules = document.querySelectorAll('.module-node');
        
        if (!svg || modules.length === 0) return;
        
        // Clear existing connections
        svg.innerHTML = '';
        
        modules.forEach(module => {
            const connections = JSON.parse(module.dataset.connections || '[]');
            const moduleRect = module.getBoundingClientRect();
            const svgRect = svg.getBoundingClientRect();
            
            connections.forEach(targetName => {
                const targetModule = document.querySelector(`[data-module="${targetName}"]`);
                if (targetModule) {
                    const targetRect = targetModule.getBoundingClientRect();
                    
                    // Calculate connection points
                    const startX = moduleRect.left - svgRect.left + moduleRect.width / 2;
                    const startY = moduleRect.top - svgRect.top + moduleRect.height / 2;
                    const endX = targetRect.left - svgRect.left + targetRect.width / 2;
                    const endY = targetRect.top - svgRect.top + targetRect.height / 2;
                    
                    // Create curved connection line
                    const path = this.createConnectionPath(startX, startY, endX, endY);
                    svg.appendChild(path);
                }
            });
        });
    }

    createConnectionPath(x1, y1, x2, y2) {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        
        // Create curved path
        const dx = x2 - x1;
        const dy = y2 - y1;
        const dr = Math.sqrt(dx * dx + dy * dy);
        const sweep = dx > 0 ? 1 : 0;
        
        const d = `M ${x1} ${y1} A ${dr} ${dr} 0 0 ${sweep} ${x2} ${y2}`;
        
        path.setAttribute('d', d);
        path.setAttribute('stroke', '#3182ce');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('fill', 'none');
        path.setAttribute('opacity', '0.6');
        path.setAttribute('class', 'connection-line');
        
        // Add arrow marker
        const marker = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const arrowMarker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
        arrowMarker.setAttribute('id', 'arrowhead');
        arrowMarker.setAttribute('markerWidth', '10');
        arrowMarker.setAttribute('markerHeight', '7');
        arrowMarker.setAttribute('refX', '10');
        arrowMarker.setAttribute('refY', '3.5');
        arrowMarker.setAttribute('orient', 'auto');
        
        const arrowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        arrowPath.setAttribute('d', 'M 0 0 L 10 3.5 L 0 7 z');
        arrowPath.setAttribute('fill', '#3182ce');
        
        arrowMarker.appendChild(arrowPath);
        marker.appendChild(arrowMarker);
        path.setAttribute('marker-end', 'url(#arrowhead)');
        
        return path;
    }

    addModuleInteractions() {
        // Module hover effects
        const moduleNodes = document.querySelectorAll('.module-node');
        moduleNodes.forEach(node => {
            node.addEventListener('mouseenter', (e) => {
                this.highlightModuleConnections(e.target.closest('.module-node'));
            });
            
            node.addEventListener('mouseleave', () => {
                this.clearModuleHighlights();
            });
            
            node.addEventListener('click', (e) => {
                this.showModuleDetails(e.target.closest('.module-node'));
            });
        });

        // Category toggle functionality
        const categoryHeaders = document.querySelectorAll('.category-header');
        categoryHeaders.forEach(header => {
            header.addEventListener('click', () => {
                this.toggleEndpointCategory(header);
            });
        });

        // API test functionality
        const testButtons = document.querySelectorAll('.test-endpoint');
        testButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                this.testApiEndpoint(e.target.closest('.test-endpoint'));
            });
        });
    }

    highlightModuleConnections(moduleNode) {
        const moduleName = moduleNode.dataset.module;
        const connections = JSON.parse(moduleNode.dataset.connections || '[]');
        
        // Highlight the current module
        moduleNode.classList.add('highlighted');
        
        // Highlight connected modules
        connections.forEach(connectionName => {
            const connectedModule = document.querySelector(`[data-module="${connectionName}"]`);
            if (connectedModule) {
                connectedModule.classList.add('connected');
            }
        });
        
        // Highlight connection lines
        const connectionLines = document.querySelectorAll('.connection-line');
        connectionLines.forEach(line => {
            line.style.opacity = '0.2';
        });
    }

    clearModuleHighlights() {
        const moduleNodes = document.querySelectorAll('.module-node');
        moduleNodes.forEach(node => {
            node.classList.remove('highlighted', 'connected');
        });
        
        const connectionLines = document.querySelectorAll('.connection-line');
        connectionLines.forEach(line => {
            line.style.opacity = '0.6';
        });
    }

    toggleEndpointCategory(header) {
        const category = header.nextElementSibling;
        const expandIcon = header.querySelector('.expand-category');
        
        if (category.classList.contains('expanded')) {
            category.classList.remove('expanded');
            category.style.display = 'none';
            expandIcon.classList.replace('fa-chevron-down', 'fa-chevron-right');
        } else {
            category.classList.add('expanded');
            category.style.display = 'block';
            expandIcon.classList.replace('fa-chevron-right', 'fa-chevron-down');
        }
    }

    async testApiEndpoint(button) {
        const url = button.dataset.url;
        const method = button.dataset.method;
        
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 테스트 중...';
        
        try {
            const response = await fetch(url, { method });
            const data = await response.json();
            
            button.innerHTML = '<i class="fas fa-check text-success"></i> 성공';
            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-play"></i> 테스트';
                button.disabled = false;
            }, 2000);
            
        } catch (error) {
            button.innerHTML = '<i class="fas fa-times text-danger"></i> 실패';
            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-play"></i> 테스트';
                button.disabled = false;
            }, 2000);
        }
    }

    showModuleDetails(moduleNode) {
        const moduleName = moduleNode.dataset.module;
        const connections = JSON.parse(moduleNode.dataset.connections || '[]');
        
        // Show module details in a tooltip or modal
        console.log(`Module: ${moduleName}, Connections: ${connections.join(', ')}`);
    }

    // Enhanced search functionality
    searchTree(searchTerm) {
        const allNodes = document.querySelectorAll('.tree-node');
        const term = searchTerm.toLowerCase().trim();
        
        if (!term) {
            // Show all nodes and remove highlights if search is empty
            allNodes.forEach(node => {
                node.parentElement.style.display = '';
                node.classList.remove('search-highlight');
            });
            return;
        }
        
        let matchFound = false;
        allNodes.forEach(node => {
            const fileName = node.querySelector('.file-name, .folder-name');
            const nodeText = fileName ? fileName.textContent.toLowerCase() : '';
            const matches = nodeText.includes(term);
            
            if (matches) {
                matchFound = true;
                node.parentElement.style.display = '';
                node.classList.add('search-highlight');
                // Expand parent nodes to show matches
                this.expandParents(node.parentElement);
            } else {
                node.parentElement.style.display = 'none';
                node.classList.remove('search-highlight');
            }
        });
        
        // Show a message if no matches found
        const searchMessage = document.getElementById('search-message');
        if (!matchFound && term) {
            if (!searchMessage) {
                const message = document.createElement('div');
                message.id = 'search-message';
                message.className = 'alert alert-info text-center mt-3';
                message.innerHTML = `<i class="fas fa-search"></i> "${term}"에 대한 검색 결과가 없습니다.`;
                document.getElementById('folder-tree').appendChild(message);
            }
        } else if (searchMessage) {
            searchMessage.remove();
        }
    }

    expandParents(node) {
        let parent = node.parentElement;
        while (parent) {
            if (parent.classList.contains('tree-children')) {
                parent.classList.add('expanded');
                // Find corresponding tree-node and mark as expanded
                const parentNode = parent.previousElementSibling;
                if (parentNode && parentNode.classList.contains('tree-node')) {
                    parentNode.classList.add('expanded');
                }
            }
            parent = parent.parentElement;
        }
    }

    expandAllNodes() {
        const expandableNodes = document.querySelectorAll('.tree-node.expandable');
        
        expandableNodes.forEach(node => {
            const nodeId = node.dataset.nodeId;
            const children = document.getElementById(`children-${nodeId}`);
            const expandIcon = node.querySelector('.expand-icon');
            
            if (children && children.classList.contains('collapsed')) {
                children.classList.remove('collapsed');
                children.classList.add('expanded');
                node.classList.add('expanded');
                if (expandIcon) {
                    expandIcon.textContent = '▼';
                }
            }
        });
    }

    collapseAllNodes() {
        const expandableNodes = document.querySelectorAll('.tree-node.expandable');
        
        expandableNodes.forEach(node => {
            const nodeId = node.dataset.nodeId;
            const children = document.getElementById(`children-${nodeId}`);
            const expandIcon = node.querySelector('.expand-icon');
            
            if (children && children.classList.contains('expanded')) {
                children.classList.remove('expanded');
                children.classList.add('collapsed');
                node.classList.remove('expanded');
                if (expandIcon) {
                    expandIcon.textContent = '▶';
                }
            }
        });
    }

    showError(message) {
        console.error(message);
        
        // Show error in main containers
        const containers = ['folder-tree', 'core-modules', 'api-endpoints', 'file-stats'];
        containers.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>오류:</strong> ${message}
                    </div>
                `;
            }
        });
        
        // Reset stats to show error state
        document.getElementById('total-files').textContent = 'Error';
        document.getElementById('python-files').textContent = 'Error';
        document.getElementById('js-files').textContent = 'Error';
        document.getElementById('total-directories').textContent = 'Error';
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.projectStructureManager = new ProjectStructureManager();
});
</script>
{% endblock %}