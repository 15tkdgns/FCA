<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCA Real-time Detection Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .priority-critical { border-left: 4px solid #dc3545; }
        .priority-high { border-left: 4px solid #fd7e14; }
        .priority-medium { border-left: 4px solid #ffc107; }
        .priority-low { border-left: 4px solid #6c757d; }
        
        .detection-card {
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .detection-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-online { 
            color: #28a745; 
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .alert-panel {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="display-5 fw-bold">
                        <i class="fas fa-tachometer-alt me-3" style="color: #007bff;"></i>
                        FCA Real-time Detection Dashboard
                    </h1>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2" id="system-status">
                            <i class="fas fa-circle status-online"></i> System Online
                        </span>
                        <span class="text-muted" id="last-updated">
                            Last updated: Loading...
                        </span>
                    </div>
                </div>
                <hr class="mt-3 mb-4">
            </div>
        </div>

        <!-- Real-time Metrics -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card detection-card priority-critical">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-3x text-danger mb-3"></i>
                        <h5 class="card-title">Fraud Detected</h5>
                        <div class="metric-value text-danger" id="fraud-count">0</div>
                        <small class="text-muted">Last 24 hours</small>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card detection-card priority-high">
                    <div class="card-body text-center">
                        <i class="fas fa-user-times fa-3x text-warning mb-3"></i>
                        <h5 class="card-title">High Risk Customers</h5>
                        <div class="metric-value text-warning" id="churn-count">0</div>
                        <small class="text-muted">Require attention</small>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card detection-card priority-medium">
                    <div class="card-body text-center">
                        <i class="fas fa-comment-dots fa-3x text-info mb-3"></i>
                        <h5 class="card-title">Negative Sentiment</h5>
                        <div class="metric-value text-info" id="sentiment-count">0</div>
                        <small class="text-muted">Recent feedback</small>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card detection-card priority-low">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
                        <h5 class="card-title">Total Processed</h5>
                        <div class="metric-value text-success" id="total-processed">0</div>
                        <small class="text-muted">All detections</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Critical Alerts Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bell me-2"></i>
                            Critical Alerts
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshAlerts()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <span class="badge bg-danger" id="alert-count">0</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert-panel" id="alerts-container">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <p>Loading alerts...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Testing Panel -->
        <div class="row mb-4">
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">üîç Fraud Detection Status</h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <div class="mb-3">
                                <span class="badge bg-success fs-6">System Active</span>
                            </div>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="mb-2">
                                        <strong>Total Scanned</strong>
                                        <div class="text-primary h5">50,000+</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-2">
                                        <strong>Detection Rate</strong>
                                        <div class="text-success h5">99.92%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">üë§ Customer Attrition Monitor</h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <div class="mb-3">
                                <span class="badge bg-warning fs-6">Monitoring Active</span>
                            </div>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="mb-2">
                                        <strong>Risk Rate</strong>
                                        <div class="text-warning h5">20.3%</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-2">
                                        <strong>Accuracy</strong>
                                        <div class="text-success h5">89.4%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">üí¨ Sentiment Analysis Monitor</h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <div class="mb-3">
                                <span class="badge bg-info fs-6">Processing Active</span>
                            </div>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="mb-2">
                                        <strong>Analyzed</strong>
                                        <div class="text-info h5">15,000+</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-2">
                                        <strong>Accuracy</strong>
                                        <div class="text-success h5">86.7%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        
        // Set up auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);
        
        // Set up test forms
        setupTestForms();
    });

    async function loadDashboardData() {
        try {
            // Load dashboard summary
            const response = await fetch('/api/detection/dashboard/summary');
            const data = await response.json();
            
            if (data.status === 'success') {
                updateMetrics(data.data);
                updateSystemStatus(data.data);
            }
            
            // Load critical alerts
            await loadCriticalAlerts();
            
            updateLastUpdated();
            
        } catch (error) {
            console.error('Failed to load dashboard data:', error);
            updateSystemStatus({ system_status: 'degraded' });
        }
    }

    function updateMetrics(data) {
        const stats = data.performance_stats || {};
        const alerts = data.recent_alerts || {};
        
        document.getElementById('fraud-count').textContent = stats.fraud_detected || 0;
        document.getElementById('churn-count').textContent = stats.high_risk_customers || 0;
        document.getElementById('sentiment-count').textContent = alerts.high || 0;
        document.getElementById('total-processed').textContent = stats.total_processed || 0;
    }

    function updateSystemStatus(data) {
        const statusElement = document.getElementById('system-status');
        
        if (data.system_status === 'operational') {
            statusElement.className = 'badge bg-success me-2';
            statusElement.innerHTML = '<i class="fas fa-circle status-online"></i> System Online';
        } else {
            statusElement.className = 'badge bg-danger me-2';
            statusElement.innerHTML = '<i class="fas fa-circle"></i> System Degraded';
        }
    }

    async function loadCriticalAlerts() {
        try {
            const response = await fetch('/api/detection/alerts/critical?hours=24');
            const data = await response.json();
            
            if (data.status === 'success') {
                displayAlerts(data.data.alerts);
                document.getElementById('alert-count').textContent = data.data.total_count;
            }
            
        } catch (error) {
            console.error('Failed to load alerts:', error);
            document.getElementById('alerts-container').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load alerts
                </div>
            `;
        }
    }

    function displayAlerts(alerts) {
        const container = document.getElementById('alerts-container');
        
        if (!alerts || alerts.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                    <p>No critical alerts</p>
                </div>
            `;
            return;
        }
        
        const alertsHtml = alerts.map(alert => `
            <div class="alert alert-${alert.color} priority-${alert.priority.toLowerCase()} mb-2">
                <div class="d-flex align-items-center">
                    <i class="${alert.icon} me-3"></i>
                    <div class="flex-grow-1">
                        <strong>${alert.type.toUpperCase()}</strong> - Risk: ${alert.risk_level}
                        <br>
                        <small class="text-muted">
                            ID: ${alert.id} | ${alert.timestamp}
                            ${alert.action_required ? ' | <strong>Action Required</strong>' : ''}
                        </small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-light text-dark">${alert.risk_score}</span>
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = alertsHtml;
    }

    function setupTestForms() {
        // Fraud Detection Test
        document.getElementById('fraud-test-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Convert to numbers
            Object.keys(data).forEach(key => {
                data[key] = parseFloat(data[key]);
            });
            
            try {
                const response = await fetch('/api/detection/fraud/detect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                displayTestResult('fraud-result', result);
                
            } catch (error) {
                displayTestError('fraud-result', error);
            }
        });
        
        // Churn Prediction Test
        document.getElementById('churn-test-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Convert numeric fields
            ['CreditScore', 'Age', 'Tenure', 'Balance'].forEach(field => {
                if (data[field]) data[field] = parseFloat(data[field]);
            });
            
            try {
                const response = await fetch('/api/detection/customer/churn', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                displayTestResult('churn-result', result);
                
            } catch (error) {
                displayTestError('churn-result', error);
            }
        });
        
        // Sentiment Analysis Test
        document.getElementById('sentiment-test-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/detection/sentiment/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                displayTestResult('sentiment-result', result);
                
            } catch (error) {
                displayTestError('sentiment-result', error);
            }
        });
    }

    function displayTestResult(containerId, result) {
        const container = document.getElementById(containerId);
        
        if (result.status === 'success') {
            const data = result.data;
            let resultHtml = '<div class="alert alert-success alert-sm mt-2">';
            
            if (data.is_fraud !== undefined) {
                resultHtml += `
                    <strong>Fraud: ${data.is_fraud ? 'YES' : 'NO'}</strong><br>
                    Probability: ${(data.fraud_probability * 100).toFixed(1)}%<br>
                    Risk: ${data.risk_level}
                `;
            } else if (data.will_churn !== undefined) {
                resultHtml += `
                    <strong>Will Churn: ${data.will_churn ? 'YES' : 'NO'}</strong><br>
                    Probability: ${(data.churn_probability * 100).toFixed(1)}%<br>
                    Risk: ${data.risk_level}
                `;
            } else if (data.sentiment !== undefined) {
                resultHtml += `
                    <strong>Sentiment: ${data.sentiment.toUpperCase()}</strong><br>
                    Confidence: ${(data.confidence * 100).toFixed(1)}%<br>
                    Attention: ${data.requires_attention ? 'YES' : 'NO'}
                `;
            }
            
            resultHtml += '</div>';
            container.innerHTML = resultHtml;
            
        } else {
            displayTestError(containerId, result.message);
        }
    }

    function displayTestError(containerId, error) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
            <div class="alert alert-danger alert-sm mt-2">
                <strong>Error:</strong> ${error}
            </div>
        `;
    }

    function updateLastUpdated() {
        document.getElementById('last-updated').textContent = 
            `Last updated: ${new Date().toLocaleTimeString()}`;
    }

    function refreshAlerts() {
        loadCriticalAlerts();
    }
    </script>
</body>
</html>