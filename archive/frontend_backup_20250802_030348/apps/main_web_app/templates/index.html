{% extends "base.html" %}

{% block title %}FCA Analysis Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="display-4 fw-bold">
                üìä FCA Analysis Dashboard
            </h1>
            <div class="text-muted">
                <i class="fas fa-calendar-alt me-2"></i>
                {{ timestamp }}
            </div>
        </div>
        <hr class="mt-3 mb-4">
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-5" id="summary-cards">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-primary text-white h-100 summary-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-2 opacity-90">ü§ñ Total Models</h6>
                        <h2 class="mb-0 fw-bold" id="total-models">{{ stats.total_models if stats else 12 }}</h2>
                        <small class="opacity-75">ML Models Trained</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-robot fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-success text-white h-100 summary-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-2 opacity-90">üìä Datasets</h6>
                        <h2 class="mb-0 fw-bold" id="total-datasets">{{ stats.total_datasets if stats else 4 }}</h2>
                        <small class="opacity-75">Processed Successfully</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-info text-white h-100 summary-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-2 opacity-90">üè∑Ô∏è Domains</h6>
                        <h2 class="mb-0 fw-bold" id="total-domains">3</h2>
                        <small class="opacity-75">Analysis Categories</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-layer-group fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-warning text-white h-100 summary-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-2 opacity-90">üìà Performance</h6>
                        <h2 class="mb-0 fw-bold" id="avg-performance">{{ "%.1f"|format(stats.average_accuracy) }}%</h2>
                        <small class="opacity-75">Overall Model Score</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-bar fa-3x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Charts Row -->
<div class="row mb-4">
    <div class="col-lg-8 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    üìä Performance Overview by Domain
                </h5>
            </div>
            <div class="card-body">
                <div id="overview-chart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    ü•ß Model Distribution
                </h5>
            </div>
            <div class="card-body">
                <div id="distribution-chart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Secondary Charts Row -->
<div class="row mb-4">
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    ‚ö° Success Metrics
                </h5>
            </div>
            <div class="card-body">
                <div id="success-chart" style="height: 350px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    üéØ Performance Radar
                </h5>
            </div>
            <div class="card-body">
                <div id="radar-chart" style="height: 350px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Monitoring Section -->
<div class="row mb-4">
    <div class="col-lg-4 mb-3">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    ‚ö° Real-time Performance
                </h5>
            </div>
            <div class="card-body">
                <div class="performance-summary">
                    <div class="metric-item mb-3">
                        <span class="metric-label">Memory Usage</span>
                        <span class="metric-value badge bg-info" id="perf-memory">--</span>
                    </div>
                    <div class="metric-item mb-3">
                        <span class="metric-label">API Response</span>
                        <span class="metric-value badge bg-success" id="perf-api">--</span>
                    </div>
                    <div class="metric-item mb-3">
                        <span class="metric-label">Chart Render</span>
                        <span class="metric-value badge bg-warning" id="perf-charts">--</span>
                    </div>
                </div>
                <div class="performance-details mt-3" id="performance-details">
                    <small class="text-muted">Monitoring system performance...</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    üèÜ Best Performing Models
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="best-performers">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Module Health Check Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    üîß Module Health Status
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="alert alert-success">
                        <h6 class="mb-2">
                            <i class="fas fa-heartbeat me-2"></i>
                            System Health: HEALTHY
                        </h6>
                        <p class="mb-0">
                            5/5 modules healthy (100.0%)
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-success h-100">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <h6 class="card-title mb-2">Fraud</h6>
                                <small class="text-muted">Engine operational</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-success h-100">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <h6 class="card-title mb-2">Sentiment</h6>
                                <small class="text-muted">Engine operational</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-success h-100">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <h6 class="card-title mb-2">Attrition</h6>
                                <small class="text-muted">Engine operational</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-success h-100">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <h6 class="card-title mb-2">Performance</h6>
                                <small class="text-muted">Calculator available</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-success h-100">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <h6 class="card-title mb-2">Monitoring</h6>
                                <small class="text-muted">System monitoring active</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard-safe.js') }}"></script>
<script>
// Module testing functionality
async function runModuleTest() {
    const resultsDiv = document.getElementById('module-test-results');
    const statusCardsDiv = document.getElementById('module-status-cards');
    const testButton = document.querySelector('button[onclick="runModuleTest()"]');
    
    // Show loading state
    testButton.disabled = true;
    testButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
    
    resultsDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Running comprehensive module tests...</p>
        </div>
    `;
    
    try {
        // Call the quick module test API
        const response = await fetch('/api/test/modules/quick');
        const result = await response.json();
        
        if (result.status === 'success') {
            displayModuleTestResults(result.data);
        } else {
            throw new Error(result.message || 'Test failed');
        }
        
    } catch (error) {
        console.error('Module test error:', error);
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Test Failed:</strong> ${error.message}
            </div>
        `;
    } finally {
        // Reset button
        testButton.disabled = false;
        testButton.innerHTML = '<i class="fas fa-play me-1"></i>Run Test';
    }
}

function displayModuleTestResults(data) {
    const resultsDiv = document.getElementById('module-test-results');
    const statusCardsDiv = document.getElementById('module-status-cards');
    
    // Show summary
    const healthColor = data.summary.overall_status === 'healthy' ? 'success' : 
                       data.summary.overall_status === 'degraded' ? 'warning' : 'danger';
    
    resultsDiv.innerHTML = `
        <div class="alert alert-${healthColor}">
            <h6 class="mb-2">
                <i class="fas fa-heartbeat me-2"></i>
                System Health: ${data.summary.overall_status.toUpperCase()}
            </h6>
            <p class="mb-0">
                ${data.summary.healthy_modules}/${data.summary.total_modules} modules healthy 
                (${data.summary.health_percentage.toFixed(1)}%)
            </p>
        </div>
    `;
    
    // Show detailed module cards
    let cardsHtml = '';
    for (const [moduleName, moduleData] of Object.entries(data.modules)) {
        const isHealthy = moduleData.status === 'healthy';
        const cardColor = isHealthy ? 'success' : 'danger';
        const icon = isHealthy ? 'check-circle' : 'exclamation-circle';
        
        cardsHtml += `
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card border-${cardColor} h-100">
                    <div class="card-body text-center p-3">
                        <i class="fas fa-${icon} fa-2x text-${cardColor} mb-2"></i>
                        <h6 class="card-title mb-2">${moduleName.charAt(0).toUpperCase() + moduleName.slice(1)}</h6>
                        <small class="text-muted">${moduleData.details}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    statusCardsDiv.innerHTML = cardsHtml;
    statusCardsDiv.style.display = 'block';
}
</script>
{% endblock %}